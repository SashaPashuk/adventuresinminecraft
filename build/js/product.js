import API from"./services/api.js";import{renderShopItemInfoHTML,addToastNotification}from"./utils/helpers.js";import{ContentLoadingEventObserever,LanguageEventObserever}from"./utils/observer.js";import{getLocalizedError}from"./services/errorsLanguageLocalization.js";import{SHOP_ITEM_TIME_USAGE}from"./contants/constants.js";import{ITEM_ADDED_TO_CART_ERROR,ITEM_ADDED_TO_CART_SUCCESS,ITEM_DURATION_SERVER_ERROR,TOKEN_NOT_EXISTS,errorsLanguageLocalizationsEnum}from"./contants/errors.js";const lsTokens=localStorage.getItem("tokens");let lsShopOrderItems=localStorage.getItem("orderItems")&&JSON.parse(localStorage.getItem("orderItems"))||[];LanguageEventObserever.subscribe(async e=>{var t=localStorage.getItem("item_data"),e=await API.getOneShopItem({languageCode:e.language,itemId:JSON.parse(t)?.id||""});renderShopItemInfoHTML(e),addBuyShopItemEventListener(e),addShopItemAmountEventListener(),addShopItemUsageEventListener()}),document.addEventListener("DOMContentLoaded",async()=>{var e=localStorage.getItem("item_data"),t=localStorage.getItem("language"),t=await API.getOneShopItem({languageCode:t,itemId:JSON.parse(e)?.id||""});renderShopItemInfoHTML(t),addBuyShopItemEventListener(t),addShopItemAmountEventListener(),addShopItemUsageEventListener(),ContentLoadingEventObserever.broadcast(!0)});const addBuyShopItemEventListener=r=>{var e=document.querySelector(".buy-block__buy-btn");const a=document.querySelector(".quantity-control__number-title"),n=document.querySelector(".cart-container-count");e?.addEventListener("click",async e=>{e.preventDefault();e=document.querySelector(".content__usage-actions")?.querySelector(".selected");if(!lsTokens)return lsShopOrderItems.find(e=>e.id===r.id)?void addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_ADDED_TO_CART_ERROR)}):r.is_one_time&&1!==Number(a.innerHTML)?void addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_AMOUNT_CAN_NOT_BE_BIGGER_THEN_ONE_ERROR)}):r.forever_price||e.getAttribute("data-type")!==SHOP_ITEM_TIME_USAGE.Forever?(t=[...lsShopOrderItems,{...r,amount:Number(a.innerHTML),time_to_use:SHOP_ITEM_TIME_USAGE["30_DAYS"],sum_item_price:Number(r.price)}],lsShopOrderItems=t,localStorage.setItem("orderItems",JSON.stringify(t)),addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_ADDED_TO_CART_SUCCESS)}),void(n.innerHTML=Number(n.innerHTML)+1)):void addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_DURATION_ERROR)});var t=await API.addShopItemToCart({amount:a.innerHTML,item_id:r.id,time_to_use:"30"===e.getAttribute("data-type")?SHOP_ITEM_TIME_USAGE["30_DAYS"]:SHOP_ITEM_TIME_USAGE.Forever}),e=t?.time_to_use&&t?.time_to_use[0]||"",o=t?.amount&&t?.amount[0]||"";e&&addToastNotification({message:e===ITEM_DURATION_SERVER_ERROR?getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_DURATION_ERROR):e}),Boolean(o)&&addToastNotification({message:o}),t===ITEM_ADDED_TO_CART_ERROR&&addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_ADDED_TO_CART_ERROR)}),t===ITEM_ADDED_TO_CART_SUCCESS&&t?.detail!==TOKEN_NOT_EXISTS&&(addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_ADDED_TO_CART_SUCCESS)}),n.innerHTML=Number(n.innerHTML)+1)})},addShopItemAmountEventListener=()=>{const e=document.querySelector(".quantity-control__number-title");var t=document.querySelector(".quantity-control__number-btn-reduce"),o=document.querySelector(".quantity-control__number-btn-increase");let r=parseInt(e.textContent);function a(){e.textContent=r}t.addEventListener("click",()=>{1<r&&(r--,a(),s())}),o.addEventListener("click",()=>{r++,a(),s()});const n=document.getElementById("product_price");let i=parseFloat(n.textContent.slice(1));function s(){var e=Number(i*r).toFixed(2);n.textContent="â‚¬"+e}},addShopItemUsageEventListener=()=>{const t=document.querySelector(".content__usage-actions")?.querySelectorAll("button");t?.forEach(e=>{e.addEventListener("click",async()=>{("30"===e.getAttribute("data-type")?(t[0].classList.add("selected"),t[1]):(t[1].classList.add("selected"),t[0])).classList.remove("selected")})})};