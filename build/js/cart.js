import API from"../js/services/api.js";import{addToastNotification,renderCartItemsHTML,renderServerDropdownItemsHTML}from"./utils/helpers.js";import{getLocalizedError}from"./services/errorsLanguageLocalization.js";import{ContentLoadingEventObserever,ShopOrderItemsEventObserever}from"./utils/observer.js";import{FIELD_NOT_EMPTY_ERROR,ITEM_AMOUNT_CAN_NOT_BE_CHANGED_ERROR,ITEM_AMOUNT_CHANGED_SUCCESS,ITEM_DELETED_FROM_CART_SUCCESS,ITEM_DURATION_SERVER_ERROR,ITEM_DURATION_SUCCESS,NO_ACTIVE_ORDER_ERROR,errorsLanguageLocalizationsEnum}from"./contants/errors.js";import{SHOP_ITEM_TIME_USAGE}from"./contants/constants.js";const lsTokens=localStorage.getItem("tokens");let lsShopOrderItems=localStorage.getItem("orderItems");ShopOrderItemsEventObserever.subscribe(e=>{renderCartItemsHTML(e),renderOverallPaymentSumHTML(e),addProductDeleteButtonEventListener(e),addProductIncreaseDecreasButtonsEventListener(e),addOrderItemsUsageButtonsEventListener(e),ContentLoadingEventObserever.broadcast(!0)}),document.addEventListener("DOMContentLoaded",async()=>{var e=await API.getShopOrderItems(),t=await API.getShopServersRequest(),e=lsShopOrderItems&&JSON.parse(lsShopOrderItems)||e;renderCartItemsHTML(e),renderOverallPaymentSumHTML(e),renderServerDropdownItemsHTML(t),addProductDeleteButtonEventListener(e),addProductIncreaseDecreasButtonsEventListener(e),addOrderItemsUsageButtonsEventListener(e),addCartPaymentButtonEventListener(),addServersDropdownEventListener(),ContentLoadingEventObserever.broadcast(!0)});const addCartPaymentButtonEventListener=()=>{var e=document.querySelector("#cart-payment-button");const o=document.querySelector("#check_policy");e?.addEventListener("click",async e=>{var t,r;e.preventDefault(),o.checked=!0,lsTokens?(e=document.querySelector(".cartPage-summary-payment"),t=document.querySelector("#cart-payment-nickname"),r=document.querySelector("#dropdown-selected-item"),r=(t=await API.createPaymentRequest({user_nickname:t.value,server:r.innerHTML}))?.user_nickname&&t?.user_nickname[0]||"",[FIELD_NOT_EMPTY_ERROR].includes(r)&&((e?.querySelector('label[for="nickname"]')).innerHTML=getLocalizedError(errorsLanguageLocalizationsEnum.USER_VALID_NICKNAME_ERROR)),t===NO_ACTIVE_ORDER_ERROR&&addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.NO_ACTIVE_ORDER_ERROR)}),t?.redirect_url&&(window.open(t.redirect_url,"_blank"),window.open("/home","_self"))):addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.USER_SHOULD_LOGIN_FIRST)})})},addServersDropdownEventListener=()=>{const r=document.querySelector(".dropdown-custom__selection"),o=document.querySelector(".dropdown-custom__container");r?.addEventListener("click",()=>{o.classList.toggle("hidden"),r.classList.toggle("dropdown-custom__selection-open");const e=document.querySelectorAll(".dropdown-custom__container__item");{const t=r?.querySelector("span");e?.forEach(e=>{e.addEventListener("click",()=>{t.innerHTML=e.innerHTML,o.classList.add("hidden")})})}})},addProductIncreaseDecreasButtonsEventListener=i=>{document.querySelectorAll(".cartPage-list-item")?.forEach((t,r)=>{var e=t.querySelector(".cart-item-increase-button"),o=t.querySelector(".cart-item-decrease-button");const a=t.querySelector(".cart-item-amount");e.addEventListener("click",async()=>{var e;lsTokens?((e=await API.updateShopItemInCart(t.getAttribute("data-cart-id"),{amount:Number(a.innerHTML)+1}))===ITEM_AMOUNT_CAN_NOT_BE_CHANGED_ERROR&&addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_AMOUNT_CAN_NOT_BE_CHANGED_ERROR)}),e===ITEM_AMOUNT_CHANGED_SUCCESS&&(modifyOverallPaymentSumHTML("increase",i[r].price||0),a.textContent=Number(a.innerHTML)+1,ShopOrderItemsEventObserever.broadcast(i.map(e=>({...e,amount:e.id===i[r].id?e.amount+1:e.amount,sum_item_price:e.id===i[r].id?e.time_to_use===SHOP_ITEM_TIME_USAGE.Forever?(e.amount+1)*e.forever_price:(e.amount+1)*e.price:e.sum_item_price}))))):i[r].is_one_time?addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_AMOUNT_CAN_NOT_BE_CHANGED_ERROR)}):(modifyOverallPaymentSumHTML("increase",i[r].price||0),a.textContent=Number(a.innerHTML)+1,e=i.map(e=>({...e,amount:e.id===i[r].id?e.amount+1:e.amount,sum_item_price:e.id===i[r].id?e.time_to_use===SHOP_ITEM_TIME_USAGE.Forever?(e.amount+1)*e.forever_price:(e.amount+1)*e.price:e.sum_item_price})),lsShopOrderItems=e,localStorage.setItem("orderItems",JSON.stringify(e)),ShopOrderItemsEventObserever.broadcast(e))}),o.addEventListener("click",async()=>{var e;lsTokens?((e=await API.updateShopItemInCart(t.getAttribute("data-cart-id"),{amount:Number(a.innerHTML)-1}))===ITEM_AMOUNT_CAN_NOT_BE_CHANGED_ERROR&&addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_AMOUNT_CAN_NOT_BE_CHANGED_ERROR)}),e===ITEM_AMOUNT_CHANGED_SUCCESS&&(modifyOverallPaymentSumHTML("decrease",i[r].price||0),a.textContent=Number(a.innerHTML)-1,ShopOrderItemsEventObserever.broadcast(i.map(e=>({...e,amount:e.id===i[r].id?e.amount-1:e.amount,sum_item_price:e.id===i[r].id?e.time_to_use===SHOP_ITEM_TIME_USAGE.Forever?(e.amount-1)*e.forever_price:(e.amount-1)*e.price:e.sum_item_price}))))):i[r].is_one_time?addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_AMOUNT_CAN_NOT_BE_CHANGED_ERROR)}):1===Number(a.innerHTML)?addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_AMOUNT_CAN_NOT_BE_LESS_THEN_ONE_ERROR)}):(modifyOverallPaymentSumHTML("decrease",i[r].price||0),a.textContent=Number(a.innerHTML)-1,e=i.map(e=>({...e,amount:e.id===i[r].id?e.amount-1:e.amount,sum_item_price:e.id===i[r].id?(e.amount-1)*e.price:e.sum_item_price})),lsShopOrderItems=e,localStorage.setItem("orderItems",JSON.stringify(e)),ShopOrderItemsEventObserever.broadcast(e))})})},addProductDeleteButtonEventListener=o=>{var e=document.querySelectorAll(".cart-item-delete-button");const a=document.querySelector(".cart-container-count");e.forEach((t,r)=>{t.addEventListener("click",async e=>{e.stopPropagation(),e.preventDefault();document.querySelector(`li[data-cart-id="${t.getAttribute("data-id")}"]`);lsTokens?await API.deleteShopItemFromCart(o[r].product_id)===ITEM_DELETED_FROM_CART_SUCCESS&&(addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_DELETED_FROM_CART_SUCCESS)}),ShopOrderItemsEventObserever.broadcast(o.filter(e=>e.id!==o[r].id)),a.innerHTML=Number(a.innerHTML)-1):(e=o.filter(e=>e.id!==o[r].id),lsShopOrderItems=e,localStorage.setItem("orderItems",JSON.stringify(e)),ShopOrderItemsEventObserever.broadcast(e),addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_DELETED_FROM_CART_SUCCESS)}),a.innerHTML=Number(a.innerHTML)-1)})})},addOrderItemsUsageButtonsEventListener=i=>{document.querySelectorAll(".cartPage-list-item")?.forEach((o,a)=>{o.querySelectorAll(".cartPage-list-item-usage-actions button")?.forEach(r=>{r.addEventListener("click",async()=>{if("30"===r.getAttribute("data-type")){if(!lsTokens)return i[a].forever_price?(e=i.map(e=>({...e,time_to_use:e.id===i[a].id?SHOP_ITEM_TIME_USAGE["30_DAYS"]:e.time_to_use,sum_item_price:e.id===i[a].id?+e.amount*+e.price:e.sum_item_price})),lsShopOrderItems=e,localStorage.setItem("orderItems",JSON.stringify(e)),void ShopOrderItemsEventObserever.broadcast(e)):void addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_DURATION_ERROR)});var e=await API.updateShopItemDurationInCart({item_id:o.getAttribute("data-cart-id"),time_to_use:SHOP_ITEM_TIME_USAGE["30_DAYS"]}),t=e?.time_to_use&&e?.time_to_use[0]||"";t&&addToastNotification({message:t===ITEM_DURATION_SERVER_ERROR?getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_DURATION_ERROR):t}),e===ITEM_DURATION_SUCCESS&&(addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_DURATION_SUCCESS)}),ShopOrderItemsEventObserever.broadcast(i.map(e=>({...e,time_to_use:e.id===i[a].id?SHOP_ITEM_TIME_USAGE["30_DAYS"]:e.time_to_use,sum_item_price:e.id===i[a].id?+e.amount*+e.price:e.sum_item_price}))))}else{if(!lsTokens)return i[a].forever_price?(t=i.map(e=>({...e,time_to_use:e.id===i[a].id?SHOP_ITEM_TIME_USAGE.Forever:e.time_to_use,sum_item_price:e.id===i[a].id?+e.amount*+e.forever_price:e.sum_item_price})),lsShopOrderItems=t,localStorage.setItem("orderItems",JSON.stringify(t)),void ShopOrderItemsEventObserever.broadcast(t)):void addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_DURATION_ERROR)});e=await API.updateShopItemDurationInCart({item_id:o.getAttribute("data-cart-id"),time_to_use:SHOP_ITEM_TIME_USAGE.Forever}),t=e?.time_to_use&&e?.time_to_use[0]||"";t&&addToastNotification({message:t===ITEM_DURATION_SERVER_ERROR?getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_DURATION_ERROR):t}),e===ITEM_DURATION_SUCCESS&&(addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_DURATION_SUCCESS)}),ShopOrderItemsEventObserever.broadcast(i.map(e=>({...e,time_to_use:e.id===i[a].id?SHOP_ITEM_TIME_USAGE.Forever:e.time_to_use,sum_item_price:e.id===i[a].id?+e.amount*+e.forever_price:e.sum_item_price}))))}})})})},renderOverallPaymentSumHTML=e=>{e=e.reduce((e,t)=>e+t.sum_item_price,0);document.querySelector(".cartPage-summary-payment-sum").innerHTML=e},modifyOverallPaymentSumHTML=(e,t)=>{var r=document.querySelector(".cartPage-summary-payment-sum");switch(e){case"increase":r.innerHTML=Number(r.innerHTML)+t;break;case"decrease":r.innerHTML=Number(r.innerHTML)-t}};