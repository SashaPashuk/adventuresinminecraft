import API from"../js/services/api.js";import{addToastNotification,renderCartItemsHTML,renderServerDropdownItemsHTML}from"./utils/helpers.js";import{getLocalizedError}from"./services/errorsLanguageLocalization.js";import{FIELD_NOT_EMPTY_ERROR,ITEM_AMOUNT_CAN_NOT_BE_CHANGED_ERROR,ITEM_AMOUNT_CHANGED_SUCCESS,ITEM_DELETED_FROM_CART_SUCCESS,ITEM_DURATION_SUCCESS,errorsLanguageLocalizationsEnum}from"./contants/errors.js";import{SHOP_ITEM_TIME_USAGE}from"./contants/constants.js";const lsTokens=localStorage.getItem("tokens");let lsShopOrderItems=localStorage.getItem("orderItems");document.addEventListener("DOMContentLoaded",async()=>{var e=await API.getShopOrderItems(),t=await API.getShopServersRequest(),e=lsShopOrderItems&&JSON.parse(lsShopOrderItems)||e;renderCartItemsHTML(e),renderOverallPaymentSumHTML(e),renderServerDropdownItemsHTML(t),addProductDeleteButtonEventListener(e),addProductIncreaseDecreasButtonsEventListener(e),addOrderItemsUsageButtonsEventListener(e),addCartPaymentButtonEventListener(),addServersDropdownEventListener()});const addCartPaymentButtonEventListener=()=>{document.querySelector("#cart-payment-button")?.addEventListener("click",async e=>{e.preventDefault();var e=document.querySelector(".cartPage-summary-payment"),t=document.querySelector("#cart-payment-nickname"),r=document.querySelector("#dropdown-selected-item"),t=await API.createPaymentRequest({user_nickname:t.value,server:r.innerHTML}),r=t?.user_nickname&&t?.user_nickname[0]||"";[FIELD_NOT_EMPTY_ERROR].includes(r)&&((e?.querySelector('label[for="nickname"]')).innerHTML="Enter valid nickname."),t?.redirect_url&&(window.open(t.redirect_url,"_blank"),window.location.reload())})},addServersDropdownEventListener=()=>{const r=document.querySelector(".dropdown-custom__selection"),a=document.querySelector(".dropdown-custom__container");r?.addEventListener("click",()=>{a.classList.toggle("hidden"),r.classList.toggle("dropdown-custom__selection-open");const e=document.querySelectorAll(".dropdown-custom__container__item");{const t=r?.querySelector("span");e?.forEach(e=>{e.addEventListener("click",()=>{t.innerHTML=e.innerHTML,a.classList.add("hidden")})})}})},addProductIncreaseDecreasButtonsEventListener=n=>{document.querySelectorAll(".cartPage-list-item")?.forEach((t,r)=>{var e=t.querySelector(".cart-item-increase-button"),a=t.querySelector(".cart-item-decrease-button");const o=t.querySelector(".cart-item-amount");e.addEventListener("click",async()=>{var e;lsTokens?((e=await API.updateShopItemInCart(t.getAttribute("data-cart-id"),{amount:Number(o.innerHTML)+1}))===ITEM_AMOUNT_CAN_NOT_BE_CHANGED_ERROR&&addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_AMOUNT_CAN_NOT_BE_CHANGED_ERROR)}),e===ITEM_AMOUNT_CHANGED_SUCCESS&&(modifyOverallPaymentSumHTML("increase",Number(t.querySelector(".cartPage-list-item-sum")?.innerHTML||0)),o.textContent=Number(o.innerHTML)+1)):n[r].is_one_time?addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_AMOUNT_CAN_NOT_BE_CHANGED_ERROR)}):(modifyOverallPaymentSumHTML("increase",Number(t.querySelector(".cartPage-list-item-sum")?.innerHTML||0)),o.textContent=Number(o.innerHTML)+1,e=JSON.parse(lsShopOrderItems).map(e=>({...e,amount:e.id===n[r].id?e.amount+1:e.amount})),lsShopOrderItems=e,localStorage.setItem("orderItems",JSON.stringify(e)))}),a.addEventListener("click",async()=>{var e;lsTokens?((e=await API.updateShopItemInCart(t.getAttribute("data-cart-id"),{amount:Number(o.innerHTML)+1}))===ITEM_AMOUNT_CAN_NOT_BE_CHANGED_ERROR&&addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_AMOUNT_CAN_NOT_BE_CHANGED_ERROR)}),e===ITEM_AMOUNT_CHANGED_SUCCESS&&(modifyOverallPaymentSumHTML("decrease",Number(t.querySelector(".cartPage-list-item-sum")?.innerHTML||0)),o.textContent=Number(o.innerHTML)-1)):n[r].is_one_time?addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_AMOUNT_CAN_NOT_BE_CHANGED_ERROR)}):1===Number(o.innerHTML)?addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_AMOUNT_CAN_NOT_BE_LESS_THEN_ONE_ERROR)}):(modifyOverallPaymentSumHTML("increase",Number(t.querySelector(".cartPage-list-item-sum")?.innerHTML||0)),o.textContent=Number(o.innerHTML)-1,e=JSON.parse(lsShopOrderItems).map(e=>({...e,amount:e.id===n[r].id?e.amount-1:e.amount})),lsShopOrderItems=e,localStorage.setItem("orderItems",JSON.stringify(e)))})})},addProductDeleteButtonEventListener=o=>{var e=document.querySelectorAll(".cart-item-delete-button");const n=document.querySelector(".cart-container-count");e.forEach((r,a)=>{r.addEventListener("click",async e=>{e.stopPropagation(),e.preventDefault();var t,e=document.querySelector(`li[data-cart-id="${r.getAttribute("data-id")}"]`);lsTokens?await API.deleteShopItemFromCart(o[a].product_id)===ITEM_DELETED_FROM_CART_SUCCESS&&(modifyOverallPaymentSumHTML("decrease",Number(e.querySelector(".cartPage-list-item-sum")?.innerHTML||0)),addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_DELETED_FROM_CART_SUCCESS)}),e?.remove(),n.innerHTML=Number(n.innerHTML)-1):(t=JSON.parse(lsShopOrderItems).filter(e=>e.id!==o[a].id),lsShopOrderItems=t,localStorage.setItem("orderItems",JSON.stringify(t)),modifyOverallPaymentSumHTML("decrease",Number(e.querySelector(".cartPage-list-item-sum")?.innerHTML||0)),addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_DELETED_FROM_CART_SUCCESS)}),e?.remove(),n.innerHTML=Number(n.innerHTML)-1)})})},addOrderItemsUsageButtonsEventListener=e=>{const i=lsTokens?e:JSON.parse(lsShopOrderItems);console.log("items",i),document.querySelectorAll(".cartPage-list-item")?.forEach((a,o)=>{var e=a.querySelector(".cartPage-list-item-usage-actions"),t=a.querySelectorAll(".cartPage-list-item-usage-actions button");const n=e.querySelector("#item-usage-days"),s=e.querySelector("#item-usage-forever");t?.forEach(r=>{r.addEventListener("click",async()=>{if("30"===r.getAttribute("data-type")){if(!lsTokens)return i[o].forever_price?(e=JSON.parse(lsShopOrderItems).map(e=>({...e,time_to_use:e.id===i[o].id?SHOP_ITEM_TIME_USAGE["30_DAYS"]:e.time_to_use})),lsShopOrderItems=e,void localStorage.setItem("orderItems",JSON.stringify(e))):void addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_DURATION_ERROR)});var e=await API.updateShopItemDurationInCart({item_id:a.getAttribute("data-cart-id"),time_to_use:SHOP_ITEM_TIME_USAGE["30_DAYS"]}),t=e?.time_to_use&&e?.time_to_use[0]||"";t&&addToastNotification({message:t}),e===ITEM_DURATION_SUCCESS&&(addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_DURATION_SUCCESS)}),n.classList.add("selected"),s.classList.remove("selected"))}else{if(!lsTokens)return i[o].forever_price?(t=JSON.parse(lsShopOrderItems).map(e=>({...e,time_to_use:e.id===i[o].id?SHOP_ITEM_TIME_USAGE.Forever:e.time_to_use})),lsShopOrderItems=t,void localStorage.setItem("orderItems",JSON.stringify(t))):void addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_DURATION_ERROR)});e=await API.updateShopItemDurationInCart({item_id:a.getAttribute("data-cart-id"),time_to_use:SHOP_ITEM_TIME_USAGE.Forever}),t=e?.time_to_use&&e?.time_to_use[0]||"";t&&addToastNotification({message:t}),e===ITEM_DURATION_SUCCESS&&(addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_DURATION_SUCCESS)}),n.classList.remove("selected"),s.classList.add("selected"))}})})})},renderOverallPaymentSumHTML=e=>{e=e.reduce((e,t)=>e+t.sum_item_price,0);document.querySelector(".cartPage-summary-payment-sum").innerHTML=e},modifyOverallPaymentSumHTML=(e,t)=>{var r=document.querySelector(".cartPage-summary-payment-sum");switch(e){case"increase":r.innerHTML=Number(r.innerHTML)+t;break;case"decrease":r.innerHTML=Number(r.innerHTML)-t}};