import API from"../js/services/api.js";import{addToastNotification,productSchemaGenerator,renderShopItemsListHTML}from"./utils/helpers.js";import{ContentLoadingEventObserever,CurrencyObserever,LanguageEventObserever}from"./utils/observer.js";import{getLocalizedError}from"./services/errorsLanguageLocalization.js";import{ITEM_ADDED_TO_CART_CURRENCY_ERROR,ITEM_ADDED_TO_CART_ERROR,ITEM_ADDED_TO_CART_SUCCESS,TOKEN_NOT_EXISTS,errorsLanguageLocalizationsEnum}from"./contants/errors.js";import{DEFAULT_LANGUAGE,SHOP_ITEM_SORT_PRICE_TYPES,SHOP_ITEM_TIME_USAGE,SHOP_ITEM_TYPES}from"./contants/constants.js";import{getLanguageFromURLWithoutEN}from"./utils/language.js";const lsTokens=localStorage.getItem("tokens");let lsShopOrderItems=localStorage.getItem("orderItems")&&JSON.parse(localStorage.getItem("orderItems"))||[];LanguageEventObserever.subscribe(async e=>{var t=document.querySelector(".products-svitch")?.querySelector("input[checked]"),r=document.querySelector(".dropdown-custom__selection span")?.getAttribute("data-selected-sort-name")||SHOP_ITEM_SORT_PRICE_TYPES.FROM_CHEAP_TO_EXPENSIVE,e=await API.getShopItems(e.language,{type:t?.value||SHOP_ITEM_TYPES.Survival,sort_price:r,currency:localStorage.getItem("currency")||"EUR"});renderShopItemsListHTML(e),addProductCartButtonsEventListeners(e),addProductCardsEventListeners(e),addShopItemsTypeSwitchEventListener()}),CurrencyObserever.subscribe(async e=>{var t=localStorage.getItem("language")||DEFAULT_LANGUAGE,r=document.querySelector(".products-svitch")?.querySelector("input[checked]"),o=document.querySelector(".dropdown-custom__selection span")?.getAttribute("data-selected-sort-name")||SHOP_ITEM_SORT_PRICE_TYPES.FROM_CHEAP_TO_EXPENSIVE,t=await API.getShopItems(t,{type:r?.value||SHOP_ITEM_TYPES.Survival,sort_price:o,currency:e});renderShopItemsListHTML(t),addProductCartButtonsEventListeners(t),addProductCardsEventListeners(t),addShopItemsTypeSwitchEventListener()}),document.addEventListener("DOMContentLoaded",async()=>{var e=localStorage.getItem("language")||DEFAULT_LANGUAGE,t=document.querySelector('input[type="radio"]'),t=(t?.setAttribute("checked","true"),t?.classList.add("checked"),document.querySelector(".dropdown-custom__selection span")?.getAttribute("data-selected-sort-name")||SHOP_ITEM_SORT_PRICE_TYPES.FROM_CHEAP_TO_EXPENSIVE),e=await API.getShopItems(e,{type:SHOP_ITEM_TYPES.Survival,sort_price:t,currency:localStorage.getItem("currency")||"EUR"});if(e?.results.length&&e?.results.forEach(e=>productSchemaGenerator({price:e?.forever_price||e?.price||0,name:e?.market_name||""})),renderShopItemsListHTML(e),addProductCartButtonsEventListeners(e),addProductCardsEventListeners(e),addShopItemsTypeSwitchEventListener(),addPriceSortingDropdownEventListener(),ContentLoadingEventObserever.broadcast(!0),lsTokens&&lsShopOrderItems.length){const r=document.querySelector(".cart-container-count");lsShopOrderItems.forEach(async e=>{await API.addShopItemToCart({amount:e.amount,time_to_use:e.time_to_use,item_id:e.id,currency:e.currency})===ITEM_ADDED_TO_CART_SUCCESS&&(r.innerHTML=Number(r.innerHTML)+1),localStorage.removeItem("orderItems")})}});const addProductCardsEventListeners=r=>{document.querySelectorAll(".products-card")?.forEach((e,t)=>{e.addEventListener("click",()=>{localStorage.setItem("item_data",JSON.stringify({id:r?.results[t].id,type:r?.results[t].type})),window.open(getLanguageFromURLWithoutEN()+"/pages/product?id="+r?.results[t].id,"_self")})})},addProductCartButtonsEventListeners=o=>{var e=document.querySelectorAll(".products-card__buy");const s=document.querySelector(".cart-container-count");e?.forEach((t,r)=>{t.addEventListener("click",async e=>{if(e.stopPropagation(),e.preventDefault(),!lsTokens)return lsShopOrderItems.find(e=>e.id===o.results[r].id)?void addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_ADDED_TO_CART_ERROR)}):lsShopOrderItems.find(e=>e.currency!==(localStorage.getItem("currency")||"EUR"))?void addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_ADDED_TO_CART_CURRENCY_ERROR)}):(e=[...lsShopOrderItems,{...o.results[r],amount:1,time_to_use:o.results[r].price?SHOP_ITEM_TIME_USAGE["30_DAYS"]:SHOP_ITEM_TIME_USAGE.Forever,sum_item_price:(o.results[r].price?Number(o.results[r].price):Number(o.results[r].forever_price)).toFixed(2),currency:localStorage.getItem("currency")||"EUR"}],lsShopOrderItems=e,localStorage.setItem("orderItems",JSON.stringify(e)),addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_ADDED_TO_CART_SUCCESS)}),void(s.innerHTML=Number(s.innerHTML)+1));e=await API.addShopItemToCart({amount:1,item_id:t.getAttribute("data-id"),time_to_use:o.results[r].price?SHOP_ITEM_TIME_USAGE["30_DAYS"]:SHOP_ITEM_TIME_USAGE.Forever,currency:localStorage.getItem("currency")||"EUR"});[ITEM_ADDED_TO_CART_ERROR,ITEM_ADDED_TO_CART_CURRENCY_ERROR].includes(e)&&addToastNotification({message:getLocalizedError(e===ITEM_ADDED_TO_CART_ERROR?errorsLanguageLocalizationsEnum.ITEM_ADDED_TO_CART_ERROR:errorsLanguageLocalizationsEnum.ITEM_ADDED_TO_CART_CURRENCY_ERROR)}),[ITEM_ADDED_TO_CART_ERROR,ITEM_ADDED_TO_CART_CURRENCY_ERROR].includes(e)||e?.detail===TOKEN_NOT_EXISTS||(addToastNotification({message:getLocalizedError(errorsLanguageLocalizationsEnum.ITEM_ADDED_TO_CART_SUCCESS)}),s.innerHTML=Number(s.innerHTML)+1)})})},addShopItemsTypeSwitchEventListener=()=>{var e=document.querySelector(".products-svitch");const o=document.querySelectorAll(".products-svitch input");e?.addEventListener("change",async e=>{var t=localStorage.getItem("language")||DEFAULT_LANGUAGE;const r=e.target.value;e=document.querySelector(".dropdown-custom__selection span")?.getAttribute("data-selected-sort-name")||SHOP_ITEM_SORT_PRICE_TYPES.FROM_CHEAP_TO_EXPENSIVE,t=await API.getShopItems(t,{type:r,sort_price:e,currency:localStorage.getItem("currency")||"EUR"});o?.forEach(e=>{e.value===r?(e.setAttribute("checked","true"),e.classList.add("checked")):(e.removeAttribute("checked"),e.classList.remove("checked"))}),renderShopItemsListHTML(t),addProductCartButtonsEventListeners(t),addProductCardsEventListeners(t)})},addPriceSortingDropdownEventListener=()=>{const t=document.querySelector(".dropdown-custom__selection"),s=document.querySelector(".dropdown-custom__container");t?.addEventListener("click",()=>{s.classList.toggle("hidden"),t.classList.toggle("dropdown-custom__selection-open");const e=document.querySelectorAll(".dropdown-custom__container__item");{const o=t?.querySelector("span");e?.forEach(async r=>{r.getAttribute("data-sort-name")===o.getAttribute("data-selected-sort-name")?r.classList.add("selected"):r.classList.remove("selected"),r.addEventListener("click",async()=>{o.textContent=r.textContent,o.setAttribute("data-selected-sort-name",r.getAttribute("data-sort-name")),s.classList.add("hidden");var e=localStorage.getItem("language")||DEFAULT_LANGUAGE,t=document.querySelector(".products-svitch .checked"),e=await API.getShopItems(e,{type:t?.value||SHOP_ITEM_TYPES.Survival,sort_price:r.getAttribute("data-sort-name"),currency:localStorage.getItem("currency")||"EUR"});renderShopItemsListHTML(e),addProductCartButtonsEventListeners(e),addProductCardsEventListeners(e)})})}})};